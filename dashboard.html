<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <!-- Tambahkan Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* ... CSS yang sudah ada ... */
        
        /* Tambahkan style untuk status koneksi */
        .connection-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .connection-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .connection-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <!-- ... HTML yang sudah ada ... -->
    
    <!-- Tambahkan status koneksi -->
    <div id="connectionStatus" class="connection-status" style="display: none;"></div>
    
    <script>
        // KONFIGURASI SUPABASE - GANTI DENGAN DATA ANDA
        const SUPABASE_URL = 'https://dqlgejvsbsfuflejinzy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxbGdlanZzYnNmdWZsZWppbnp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk5NDk2ODgsImV4cCI6MjA1NTUyNTY4OH0.a2sLVozmtkPNdU4bWOnLv3swgEe1tFYy7qmOTwdzigU';
        
        // Inisialisasi Supabase Client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Cek koneksi dan autentikasi
        async function checkConnection() {
            try {
                // Cek user session
                const {  { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    alert('Anda belum login! Mengarahkan ke halaman login...');
                    window.location.href = 'login.html';
                    return false;
                }
                
                // Cek koneksi database
                const { data, error } = await supabase.from('memories').select('id').limit(1);
                
                if (error && error.code !== '42P01') { // 42P01 = table not found (tabel belum dibuat)
                    throw error;
                }
                
                document.getElementById('connectionStatus').innerHTML = 
                    `Terhubung sebagai: ${user.email}`;
                document.getElementById('connectionStatus').className = 'connection-status connection-success';
                document.getElementById('connectionStatus').style.display = 'block';
                
                return true;
                
            } catch (error) {
                console.error('Koneksi error:', error);
                document.getElementById('connectionStatus').innerHTML = 
                    `Error koneksi: ${error.message}`;
                document.getElementById('connectionStatus').className = 'connection-status connection-error';
                document.getElementById('connectionStatus').style.display = 'block';
                return false;
            }
        }

        // Jalankan pengecekan saat halaman dimuat
        window.addEventListener('load', checkConnection);

        // Function untuk menyimpan diary bersama
        async function saveDiaryBersama(content) {
            try {
                const {  { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User tidak ditemukan');
                
                const { data, error } = await supabase
                    .from('diary_entries')
                    .insert([
                        {
                            content: content,
                            user_id: user.id,
                            created_at: new Date()
                        }
                    ]);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error menyimpan diary:', error);
                throw error;
            }
        }

        // Function untuk menyimpan memory
        async function saveMemory(title, description, image_url = null) {
            try {
                const {  { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User tidak ditemukan');
                
                const { data, error } = await supabase
                    .from('memories')
                    .insert([
                        {
                            title: title,
                            description: description,
                            image_url: image_url,
                            user_id: user.id,
                            created_at: new Date()
                        }
                    ]);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error menyimpan memory:', error);
                throw error;
            }
        }

        // Function untuk menyimpan letter
        async function saveLetter(title, content, recipient) {
            try {
                const {  { user } } = await supabase.auth.getUser();
                if (!user) throw new Error('User tidak ditemukan');
                
                const { data, error } = await supabase
                    .from('letters')
                    .insert([
                        {
                            title: title,
                            content: content,
                            recipient: recipient,
                            user_id: user.id,
                            created_at: new Date()
                        }
                    ]);
                
                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error menyimpan letter:', error);
                throw error;
            }
        }

        // ... script yang sudah ada ...
    </script>
</body>
</html>
